### 微前端

微前端框架---qiankun（基于 single-spa，支持 Vue3，易用）

##### 文档：https://qiankun.umijs.org/zh/guide/getting-started

#### 如何引入微前端

##### 第一步：搭建一个主应用

1. 新建一个主应用（可用 Vue3、React、纯 HTML 均可，推荐用 Vue3 保持一致）。
2. 安装 qiankun：

```js
npm install qiankun
```

3. 在主应用中注册子应用：

```js
// main.ts
import { createApp } from "vue";
import App from "./App.vue";
import { registerMicroApps, start } from "qiankun";

createApp(App).mount("#app");

registerMicroApps([
  {
    name: "app1",
    entry: "//localhost:7101", // 子应用1的本地地址（如果同源）
    container: "#subapp-viewport",
    activeRule: "/app1",
  },
  {
    name: "app2",
    entry: "//localhost:7102", // 子应用2的本地地址（如果同源）
    container: "#subapp-viewport",
    activeRule: "/app2",
  },
]);

start();
```

3. 主应用页面预留子应用挂载点：

```js
<div id="subapp-viewport"></div>
```

##### 第二步：改造子应用的 maun.ts 动态渲染（即何时独立渲染、何时联合渲染）

1. 在每个子应用的 main.ts 里适配 qiankun：

```js
// main.ts
import { createApp } from "vue";
import App from "./App.vue";

let app = null;

function render(props = {}) {
  app = createApp(App);
  app.mount(props.container ? props.container.querySelector("#app") : "#app");
}

// 根据环境变量 决定是独立渲染还是动态渲染
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

// 挂载
export async function mount(props) {
  render(props);
}

// 卸载
export async function unmount() {
  app.unmount();
}
```

2. Vite 需加 base 配置，指定项目打包后所有静态资源（JS、CSS、图片等）的公共基础路径

##### 第三步：启动微前端项目

主应用、两个子应用分别启动（端口不能冲突）。
访问主应用，切换路由 /app1、/app2，即可看到两个子应用分别被加载。

### 常见问题

#### 一、微前端的部署方式

不管那种方式，都推荐**正式环境子应用写完整的域名**

##### 两个子应用和主应用**部署在同一台服务器上**，只要端口或路径不冲突即可，主要有两种部署方式

1. 不同端口

```js
主应用：http://your-server:7000
子应用1：http://your-server:7101
子应用2：http://your-server:7102


registerMicroApps 里面的 entry 配置:
entry: "http://your-server:7101"
entry: "http://your-server:7102"
```

2. nginx 反向代理(-----推荐这种，同域不同路径”，方便 cookie、登录态共享和统一管理-----)

```js
// 简单的nginx配置
location /app1/ {
  proxy_pass http://localhost:7101/;
}

location /app2/ {
  proxy_pass http://localhost:7102/;
}


// registerMicroApps 里面的 entry 配置:
entry: "http://your-server/app1/"
entry: "http://your-server/app2/"
```

##### 两个子应用和主应用**部署在不同一台服务器上**

```js
// main.ts
// registerMicroApps里面的配置
registerMicroApps([
  {
    name: "app1",
    entry: "https://app1.example.com", // 子应用1的完整域名
    container: "#subapp-viewport",
    activeRule: "/app1",
  },
  {
    name: "app2",
    entry: "https://app2.example.com", // 子应用2的完整域名
    container: "#subapp-viewport",
    activeRule: "/app2",
  },
]);
```

#### 二、主应用的路由配置

##### 1. 原则：

- 主应用的路由只配置“子应用挂载点”，不配置子应用内部路由。
- 每个菜单项对应一个子应用的入口路由（如 /app1、/app2）。

##### 2. 例子：

```js
// router/index.ts
import { createRouter, createWebHistory } from "vue-router";

const routes = [
  {
    path: "/app1/:catchAll(.*)*", // 匹配所有 app1 下的路由
    component: () => import("@/views/SubAppContainer.vue"), // 子应用挂载容器
  },
  {
    path: "/app2/:catchAll(.*)*",
    component: () => import("@/views/SubAppContainer.vue"),
  },
  // 其它主应用自己的页面
];

const router = createRouter({
  history: createWebHistory(),
  routes,
});

export default router;
```

##### 3. SubAppContainer.vue 文件里面一般会放 <div id="subapp-viewport"></div> 作为主应用的**挂载容器页面**，qiankun 会把子应用渲染到这个 div 里。注意:**不是引入子文件的 index.html**

#### 三、qiankun 的环境变量 window.`__POWERED_BY_QIANKUN__`

`__POWERED_BY_QIANKUN__`是 qiankun 框架在运行时自动挂载到 window 上的一个全局变量

- 当你的子应用被 qiankun 主应用加载时，qiankun 会自动在 window 上加上 window.`__POWERED_BY_QIANKUN__` = true。
- 当子应用独立运行时，这个变量不存在（undefined）。

##### 使用方法：

```js
if (!window.__POWERED_BY_QIANKUN__) {
  // 说明子应用此时在独立运行逻辑
}
```
